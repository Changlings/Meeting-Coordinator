<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html;charset=UTF-8"/>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <meta content="@ViewBag.Description" name="description"/>
    <meta content="The Changlings" name="author"/>
    <title>@ViewBag.Title</title>
    @Scripts.Render("~/bundles/modernizr")
    @Styles.Render("~/bundles/bootstrap", "~/bundles/theme")
    @RenderSection("styles", required: false)
</head>
<body class="">
<!-- BEGIN HEADER-->
<div class="header navbar navbar-inverse">
    <!-- BEGIN TOP NAVIGATION BAR -->
    <div class="navbar-inner">
        @Html.Partial("_NavigationHeaderPartial")
        @Html.Partial("_ContentHeaderPartial")
    </div>
    <!-- END TOP NAVIGATION BAR -->
</div>
<!-- END HEADER -->
<!-- BEGIN CONTENT -->
<div class="page-container row-fluid">
    @Html.Partial("_SidebarPartial")
    <!-- BEGIN PAGE CONTAINER -->
    <div class="page-content">
        <div class="content">
            @Html.Partial("_CreateMeetingPartial")
            @RenderBody()
        </div>
    </div>
    <!-- END PAGE CONTAINER -->
</div>
<!-- END CONTENT-->
@Scripts.Render("~/bundles/javascript")
@RenderSection("scripts", required: false)
<script>
    $(document).ready(function () {
        $('#schedule-meeting-sidebar').click(function (e) {
            var $meeting = $('#meeting-create');
            $meeting.find('input, textarea').each(function (index, element) {
                $(element).val("");
            });
            $meeting.find('option').each(function (index, element) {
                $(element).attr("selected", false);
            });
            $meeting.modal("show");

            //get list of attendees and list of rooms from controller
            $.ajax({
                type: "GET",
                dataType: "json",
                url: "/Home/GetSchedulingData",
                async: true,
                success: function (data, status) {
                    var rooms = data['rooms'];
                    var attendees = data['attendees'];

                    if (rooms) {
                        var meeting_room_select = $('#meeting-create').find('select[name=meeting-room]');
                        meeting_room_select.empty();
                        for (var i = 0; i < rooms.length; i++) {
                            meeting_room_select.append('<option value=' + rooms[i].ID + '>' + rooms[i].RoomNo + '</option>');
                        }
                    }
                    if (attendees) {
                        var attendee_select = $('#meeting-create').find('select[name=attendees]');
                        attendee_select.empty();
                        for (var i = 0; i < attendees.length; i++) {
                            attendee_select.append('<option value=' + attendees[i].ID + '>' + attendees[i].FirstName + ' ' + attendees[i].LastName + '</option>');
                        }
                    }
                }
            })
        });

        //after all info is filled in, check if the meeting is valid
        $('#start-time-input, #end-time-input').on({
            change: function (event) {
                var start_time = $('#start-time-input').val();
                var end_time = $('#end-time-input').val();

                //if both start and end time have been filled out
                if (start_time !== "" && end_time !== "") {

                    var roomID = $('#meeting-create').find('select[name=meeting-room]').val();
                    //TODO: change this to attendee_ids
                    var attendees = [];

                    //get all selected attendees
                    $('#attendees-multiple-select :selected').each(function (i, selected) {
                        attendees[i] = $(selected).val();
                    });

                    //if a room has been chosen and at least one attendee has been chosen 
                    if (roomID != "" && attendees.length > 0) {
                        //reformat start and end time
                        start_time = start_time.replace("T", " ");
                        end_time = end_time.replace("T", " ");

                        //send filled in data back to controller
                        $.ajax({
                            data: {
                                end_time: end_time,
                                start_time: start_time,
                                room_id: roomID,
                                attendees: attendees
                            },
                            url: "/Home/CheckAvailability",
                            type: "POST",
                            async: true,
                            dataType: "json",
                            success: function (data, status) {
                                if (status) {
                                    if (!data.meetingAvailable) {
                                        for (var i = 0; i < data.errors.Data.length; i++) {
                                            //TODO: show actual error messages to the user
                                            console.log(data.errors.Data[i]);
                                        }
                                    }
                                }
                            }
                        })
                    }
                }
            }
        })

        $('#save-new-meeting').click(function (e) {
            var title = $('#meeting-create').find('input[name=title]').val();
            var description = $('#meeting-create').find('textarea[name=description]').val();
            var room_id = $('#meeting-create').find('select[name=meeting-room]').val();
            var attendee_ids = [];

            //get all selected attendee ids
            $('#attendees-multiple-select :selected').each(function (i, selected) {
                attendee_ids[i] = $(selected).val();
            });

            var start_time = $('#start-time-input').val();
            var end_time = $('#end-time-input').val();

            $.ajax({
                data: {
                    title: title,
                    description: description,
                    room_id: room_id,
                    attendee_ids: attendee_ids,
                    start_time: start_time,
                    end_time: end_time
                },
                type: "POST",
                dataType: "json",
                url: "/Home/SaveMeeting",
                async: true,
                success: function (success) {
                    if (success) {
                        alert("Meeting created!");
                        var meeting_id = $('.external-event').length + 1;
                        $('#external-events').append('<div class="external-event">' +
                                '<span class="meeting" data-title="Meeting ' + meeting_id + '" data-attendees="" data-id="' + meeting_id + '">Meeting ' + meeting_id + '</span>' +
                                '<span class="delete-meeting pull-right"><i class="fa fa-pencil"></i><i class="fa fa-times"></i></span>' +
                                '</div>');

                        $('#meeting-create').modal('hide');
                    } else {
                        //TODO: show an actual error message and handle it
                        console.log("Error! fix this");
                    }
                }
            })
        });

        $('#save-meeting-edit').click(function(e){
            $.ajax({
                data: $('#meeting-edit').find('form').serialize(),
                url: "/Home/Edit"
            })
        });
    });
</script>
</body>
</html>
